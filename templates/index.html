<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§›ì§‘ ë¶„ì„ ì• í”Œë¦¬ì¼€ì´ì…˜</title>
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f4f9; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 2em; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        .form-grid { display: grid; grid-template-columns: 3fr 1fr; gap: 1em; margin-bottom: 1em; }
        .params-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1em; margin-bottom: 1em; }
        .param-item { display: flex; flex-direction: column; gap: 0.3em; }
        .param-item label { font-weight: bold; color: #555; font-size: 0.9em; }
        input, button { padding: 0.8em; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; }
        #map { width: 100%; height: 400px; margin-top: 1em; border: 1px solid #ddd; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5em; }
        .category-box { border: 1px solid #eee; border-radius: 8px; padding: 1em; }
        .category-box h2 { margin-top: 0; }
        .scrollable-list { max-height: 300px; overflow-y: auto; padding-right: 10px; }
        ul { list-style: none; padding: 0; }
        li { border-bottom: 1px solid #f0f0f0; padding: 0.8em 0; }
        .map-controls { margin-top: 1em; }
        .map-controls label { margin-right: 1em; }
        .loader { display: none; text-align: center; margin: 2em; }

        /* ê°œë³„ ì‹ë‹¹ ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ë§ */
        li input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
            accent-color: #007bff;
        }

        li > div {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>ë§›ì§‘ ë¶„ì„ê¸° (Kakao API ê¸°ë°˜)</h1>

        <form id="search-form">
            <div class="form-grid">
                <input type="text" id="address" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì „ë¶íŠ¹ë³„ìì¹˜ë„ ì „ì£¼ì‹œ ì™„ì‚°êµ¬ í™ì‚°ì¤‘ì•™ë¡œ 37)" required>
                <button type="submit">ì‹¤í–‰</button>
            </div>
            <h3>ë¶„ì„ íŒŒë¼ë¯¸í„° ì„¤ì •</h3>
            <div class="params-grid">
                <div class="param-item">
                    <label for="radius">ë°˜ê²½ (km)</label>
                    <input type="number" id="radius" value="3" step="0.5" title="ê²€ìƒ‰í•  ë°˜ê²½ì„ í‚¬ë¡œë¯¸í„° ë‹¨ìœ„ë¡œ ì„¤ì •">
                </div>
                <div class="param-item">
                    <label for="min_reviews">ìµœì†Œ ë¦¬ë·° ìˆ˜</label>
                    <input type="number" id="min_reviews" value="50" title="ë¶„ì„ì— í¬í•¨í•  ìµœì†Œ ë¦¬ë·° ê°œìˆ˜">
                </div>
                <div class="param-item">
                    <label for="bayes_prior">ë² ì´ì¦ˆ ì‚¬ì „ê°’</label>
                    <input type="number" id="bayes_prior" value="3.5" step="0.1" title="ë² ì´ì¦ˆ í†µê³„ì˜ ì‚¬ì „ í™•ë¥ ê°’">
                </div>
            </div>
        </form>

        <div class="loader" id="loader">ë¶„ì„ ì¤‘...</div>

        <div id="map-container" style="display:none;">
            <div id="map"></div>
            <div id="map-controls"></div>
        </div>
        
        <div class="results-grid" id="results-container"></div>
    </div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_js_key }}&libraries=services&autoload=false"></script>
    <script>
        let map;
        let markers = {}; // ì¹´í…Œê³ ë¦¬ë³„ ë§ˆì»¤ (ê¸°ì¡´ ê¸°ëŠ¥)
        let individualMarkers = {}; // ê°œë³„ ì‹ë‹¹ ë§ˆì»¤ (ìƒˆ ê¸°ëŠ¥)

        document.getElementById('search-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loader = document.getElementById('loader');
            loader.style.display = 'block';
            document.getElementById('results-container').innerHTML = '';
            document.getElementById('map-container').style.display = 'none';

            const formData = {
                address: document.getElementById('address').value,
                radius: document.getElementById('radius').value,
                min_reviews: document.getElementById('min_reviews').value,
                bayes_prior: document.getElementById('bayes_prior').value,
            };

            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'ì„œë²„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
                
                const data = await response.json();
                
                kakao.maps.load(function() {
                    console.log("Kakao Maps API is successfully loaded.");
                    loader.style.display = 'none';
                    document.getElementById('map-container').style.display = 'block';
                    displayResults(data.results);
                    initializeMap(data.center, data.results, parseFloat(formData.radius));
                });

            } catch (err) {
                loader.style.display = 'none';
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            }
        });

        function displayResults(results) {
            const container = document.getElementById('results-container');
            container.innerHTML = '';
            if (Object.keys(results).length === 0) {
                container.innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë°˜ê²½ì„ ë„“íˆê±°ë‚˜ ë‹¤ë¥¸ ì£¼ì†Œë¡œ ì‹œë„í•´ë³´ì„¸ìš”.</p>';
                return;
            }
            for (const category in results) {
                const categoryBox = document.createElement('div');
                categoryBox.className = 'category-box';
                let content = `<h2>${category} (${results[category].length}ê°œ)</h2><div class="scrollable-list"><ul>`;
                
                // ê° ì‹ë‹¹ì— ì²´í¬ë°•ìŠ¤ ì¶”ê°€ (í•µì‹¬ ìˆ˜ì • ë¶€ë¶„)
                results[category].forEach((r, index) => {
                    const restaurantId = `${category}-${index}`; // ê³ ìœ  ID ìƒì„±
                    content += `<li>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="check-${restaurantId}" 
                                onchange="toggleIndividualMarker('${restaurantId}', ${r.lat}, ${r.lng}, '${r.name}', this.checked)">
                            <div>
                                <strong>${index + 1}. ${r.name}</strong><br>
                                ì „í™”: ${r.phone}<br>
                                ë² ì´ì¦ˆ í‰ê· : ${r.bayes_avg} | ë¦¬ë·°: ${r.review_count} | ë¶„ì‚°: ${r.std_dev}
                            </div>
                        </div>
                    </li>`;
                });
                content += '</ul></div>';
                categoryBox.innerHTML = content;
                container.appendChild(categoryBox);
            }
        }

        function initializeMap(center, resultsData, radiusKm) {
            const mapContainer = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(center.lat, center.lng),
                level: 5
            };
            map = new kakao.maps.Map(mapContainer, options);

            new kakao.maps.Circle({
                center: options.center, radius: radiusKm * 1000,
                strokeWeight: 2, strokeColor: '#007bff', strokeOpacity: 0.8,
                fillColor: '#007bff', fillOpacity: 0.1
            }).setMap(map);

            const mapControls = document.getElementById('map-controls');
            mapControls.innerHTML = '<h3>ì§€ë„ì— í‘œì‹œí•˜ê¸°:</h3><p><strong>ì¹´í…Œê³ ë¦¬ë³„ í‘œì‹œ:</strong></p>';
            
            // ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ë³„ ì²´í¬ë°•ìŠ¤ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
            for (const category in resultsData) {
                markers[category] = [];
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `check-${category}`;
                checkbox.dataset.category = category;
                const label = document.createElement('label');
                label.htmlFor = `check-${category}`;
                label.textContent = category;
                mapControls.appendChild(checkbox);
                mapControls.appendChild(label);
                checkbox.addEventListener('change', (e) => {
                    const cat = e.target.dataset.category;
                    if (e.target.checked) showMarkers(cat, resultsData[cat]);
                    else hideMarkers(cat);
                });
            }

            // ê°œë³„ ì„ íƒ ì•ˆë‚´ ì¶”ê°€
            const individualInfo = document.createElement('p');
            individualInfo.innerHTML = '<strong>ê°œë³„ ì‹ë‹¹ ì„ íƒ:</strong> ìœ„ì˜ ì‹ë‹¹ ëª©ë¡ì—ì„œ ì›í•˜ëŠ” ì‹ë‹¹ ì˜† ì²´í¬ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ì„¸ìš”.';
            individualInfo.style.marginTop = '15px';
            individualInfo.style.fontSize = '0.9em';
            individualInfo.style.color = '#666';
            mapControls.appendChild(individualInfo);
        }
        
        // ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ë³„ ë§ˆì»¤ í‘œì‹œ í•¨ìˆ˜ë“¤ (ê·¸ëŒ€ë¡œ ìœ ì§€)
        function showMarkers(category, places) {
            hideMarkers(category);
            places.forEach((place, i) => {
                const position = new kakao.maps.LatLng(place.lat, place.lng);
                const marker = new kakao.maps.Marker({ map: map, position: position, title: place.name });
                const content = `<div style="padding:5px;background:white;border:1px solid black;border-radius:4px;font-size:12px;">${i+1}. ${place.name}</div>`;
                const customOverlay = new kakao.maps.CustomOverlay({ position: position, content: content, yAnchor: 2.2 });
                marker.overlay = customOverlay;
                kakao.maps.event.addListener(marker, 'mouseover', () => customOverlay.setMap(map));
                kakao.maps.event.addListener(marker, 'mouseout', () => customOverlay.setMap(null));
                markers[category].push(marker);
            });
        }

        function hideMarkers(category) {
            markers[category].forEach(marker => {
                if (marker.overlay) marker.overlay.setMap(null);
                marker.setMap(null);
            });
            markers[category] = [];
        }

        // ìƒˆë¡œìš´ ê°œë³„ ì‹ë‹¹ ë§ˆì»¤ ê´€ë¦¬ í•¨ìˆ˜ (í•µì‹¬ ì¶”ê°€ ê¸°ëŠ¥)
        function toggleIndividualMarker(restaurantId, lat, lng, name, isChecked) {
            if (isChecked) {
                // ì²´í¬ëœ ê²½ìš°: ë§ˆì»¤ ìƒì„± ë° í‘œì‹œ
                const position = new kakao.maps.LatLng(lat, lng);
                const marker = new kakao.maps.Marker({ 
                    map: map, 
                    position: position, 
                    title: name 
                });
                
                // ê°œë³„ ì„ íƒëœ ì‹ë‹¹ì€ ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ì˜ ì˜¤ë²„ë ˆì´ ì‚¬ìš©
                const content = `<div style="padding:5px;background:#ff6b6b;color:white;border:1px solid #ff4757;border-radius:4px;font-size:12px;font-weight:bold;">ğŸ“ ${name}</div>`;
                const customOverlay = new kakao.maps.CustomOverlay({ 
                    position: position, 
                    content: content, 
                    yAnchor: 2.2 
                });
                
                marker.overlay = customOverlay;
                
                // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸: ê°œë³„ ì„ íƒëœ ë§ˆì»¤ëŠ” í•­ìƒ í‘œì‹œ
                kakao.maps.event.addListener(marker, 'mouseover', () => customOverlay.setMap(map));
                kakao.maps.event.addListener(marker, 'mouseout', () => customOverlay.setMap(null));
                
                // ê°œë³„ ë§ˆì»¤ ì €ì¥
                individualMarkers[restaurantId] = marker;
                
                // ì˜¤ë²„ë ˆì´ë¥¼ ì¦‰ì‹œ í‘œì‹œ (ê°œë³„ ì„ íƒëœ ê²ƒì„ì„ ê°•ì¡°)
                customOverlay.setMap(map);
                
            } else {
                // ì²´í¬ í•´ì œëœ ê²½ìš°: ë§ˆì»¤ ì œê±°
                if (individualMarkers[restaurantId]) {
                    if (individualMarkers[restaurantId].overlay) {
                        individualMarkers[restaurantId].overlay.setMap(null);
                    }
                    individualMarkers[restaurantId].setMap(null);
                    delete individualMarkers[restaurantId];
                }
            }
        }
    </script>

</body>
</html>
