<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>맛집 분석 애플리케이션</title>
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f4f9; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 2em; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        .form-grid { display: grid; grid-template-columns: 3fr 1fr; gap: 1em; margin-bottom: 1em; }
        .params-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1em; margin-bottom: 1em; }
        .param-item { display: flex; flex-direction: column; gap: 0.3em; }
        .param-item label { font-weight: bold; color: #555; font-size: 0.9em; }
        input, button { padding: 0.8em; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; }
        #map { width: 100%; height: 400px; margin-top: 1em; border: 1px solid #ddd; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5em; }
        .category-box { border: 1px solid #eee; border-radius: 8px; padding: 1em; }
        .category-box h2 { margin-top: 0; }
        .scrollable-list { max-height: 300px; overflow-y: auto; padding-right: 10px; }
        ul { list-style: none; padding: 0; }
        li { border-bottom: 1px solid #f0f0f0; padding: 0.8em 0; }
        .map-controls { margin-top: 1em; }
        .map-controls label { margin-right: 1em; }
        .loader { display: none; text-align: center; margin: 2em; }

        /* 개별 식당 체크박스 스타일링 */
        li input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
            accent-color: #007bff;
        }

        li > div {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>맛집 분석기 (Kakao API 기반)</h1>

        <form id="search-form">
            <div class="form-grid">
                <input type="text" id="address" placeholder="주소를 입력하세요 (예: 전북특별자치도 전주시 완산구 홍산중앙로 37)" required>
                <button type="submit">실행</button>
            </div>
            <h3>분석 파라미터 설정</h3>
            <div class="params-grid">
                <div class="param-item">
                    <label for="radius">반경 (km)</label>
                    <input type="number" id="radius" value="3" step="0.5" title="검색할 반경을 킬로미터 단위로 설정">
                </div>
                <div class="param-item">
                    <label for="min_reviews">최소 리뷰 수</label>
                    <input type="number" id="min_reviews" value="50" title="분석에 포함할 최소 리뷰 개수">
                </div>
                <div class="param-item">
                    <label for="bayes_prior">베이즈 사전값</label>
                    <input type="number" id="bayes_prior" value="3.5" step="0.1" title="베이즈 통계의 사전 확률값">
                </div>
            </div>
        </form>

        <div class="loader" id="loader">분석 중...</div>

        <div id="map-container" style="display:none;">
            <div id="map"></div>
            <div id="map-controls"></div>
        </div>
        
        <div class="results-grid" id="results-container"></div>
    </div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_js_key }}&libraries=services&autoload=false"></script>
    <script>
        let map;
        let markers = {}; // 카테고리별 마커 (기존 기능)
        let individualMarkers = {}; // 개별 식당 마커 (새 기능)

        document.getElementById('search-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loader = document.getElementById('loader');
            loader.style.display = 'block';
            document.getElementById('results-container').innerHTML = '';
            document.getElementById('map-container').style.display = 'none';

            const formData = {
                address: document.getElementById('address').value,
                radius: document.getElementById('radius').value,
                min_reviews: document.getElementById('min_reviews').value,
                bayes_prior: document.getElementById('bayes_prior').value,
            };

            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '서버에서 오류가 발생했습니다.');
                }
                
                const data = await response.json();
                
                kakao.maps.load(function() {
                    console.log("Kakao Maps API is successfully loaded.");
                    loader.style.display = 'none';
                    document.getElementById('map-container').style.display = 'block';
                    displayResults(data.results);
                    initializeMap(data.center, data.results, parseFloat(formData.radius));
                });

            } catch (err) {
                loader.style.display = 'none';
                alert('오류가 발생했습니다: ' + err.message);
            }
        });

        function displayResults(results) {
            const container = document.getElementById('results-container');
            container.innerHTML = '';
            if (Object.keys(results).length === 0) {
                container.innerHTML = '<p>검색 결과가 없습니다. 반경을 넓히거나 다른 주소로 시도해보세요.</p>';
                return;
            }
            for (const category in results) {
                const categoryBox = document.createElement('div');
                categoryBox.className = 'category-box';
                let content = `<h2>${category} (${results[category].length}개)</h2><div class="scrollable-list"><ul>`;
                
                // 각 식당에 체크박스 추가 (핵심 수정 부분)
                results[category].forEach((r, index) => {
                    const restaurantId = `${category}-${index}`; // 고유 ID 생성
                    content += `<li>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="check-${restaurantId}" 
                                onchange="toggleIndividualMarker('${restaurantId}', ${r.lat}, ${r.lng}, '${r.name}', this.checked)">
                            <div>
                                <strong>${index + 1}. ${r.name}</strong><br>
                                전화: ${r.phone}<br>
                                베이즈 평균: ${r.bayes_avg} | 리뷰: ${r.review_count} | 분산: ${r.std_dev}
                            </div>
                        </div>
                    </li>`;
                });
                content += '</ul></div>';
                categoryBox.innerHTML = content;
                container.appendChild(categoryBox);
            }
        }

        function initializeMap(center, resultsData, radiusKm) {
            const mapContainer = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(center.lat, center.lng),
                level: 5
            };
            map = new kakao.maps.Map(mapContainer, options);

            new kakao.maps.Circle({
                center: options.center, radius: radiusKm * 1000,
                strokeWeight: 2, strokeColor: '#007bff', strokeOpacity: 0.8,
                fillColor: '#007bff', fillOpacity: 0.1
            }).setMap(map);

            const mapControls = document.getElementById('map-controls');
            mapControls.innerHTML = '<h3>지도에 표시하기:</h3><p><strong>카테고리별 표시:</strong></p>';
            
            // 기존 카테고리별 체크박스 (기존 기능 유지)
            for (const category in resultsData) {
                markers[category] = [];
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `check-${category}`;
                checkbox.dataset.category = category;
                const label = document.createElement('label');
                label.htmlFor = `check-${category}`;
                label.textContent = category;
                mapControls.appendChild(checkbox);
                mapControls.appendChild(label);
                checkbox.addEventListener('change', (e) => {
                    const cat = e.target.dataset.category;
                    if (e.target.checked) showMarkers(cat, resultsData[cat]);
                    else hideMarkers(cat);
                });
            }

            // 개별 선택 안내 추가
            const individualInfo = document.createElement('p');
            individualInfo.innerHTML = '<strong>개별 식당 선택:</strong> 위의 식당 목록에서 원하는 식당 옆 체크박스를 클릭하세요.';
            individualInfo.style.marginTop = '15px';
            individualInfo.style.fontSize = '0.9em';
            individualInfo.style.color = '#666';
            mapControls.appendChild(individualInfo);
        }
        
        // 기존 카테고리별 마커 표시 함수들 (그대로 유지)
        function showMarkers(category, places) {
            hideMarkers(category);
            places.forEach((place, i) => {
                const position = new kakao.maps.LatLng(place.lat, place.lng);
                const marker = new kakao.maps.Marker({ map: map, position: position, title: place.name });
                const content = `<div style="padding:5px;background:white;border:1px solid black;border-radius:4px;font-size:12px;">${i+1}. ${place.name}</div>`;
                const customOverlay = new kakao.maps.CustomOverlay({ position: position, content: content, yAnchor: 2.2 });
                marker.overlay = customOverlay;
                kakao.maps.event.addListener(marker, 'mouseover', () => customOverlay.setMap(map));
                kakao.maps.event.addListener(marker, 'mouseout', () => customOverlay.setMap(null));
                markers[category].push(marker);
            });
        }

        function hideMarkers(category) {
            markers[category].forEach(marker => {
                if (marker.overlay) marker.overlay.setMap(null);
                marker.setMap(null);
            });
            markers[category] = [];
        }

        // 새로운 개별 식당 마커 관리 함수 (핵심 추가 기능)
        function toggleIndividualMarker(restaurantId, lat, lng, name, isChecked) {
            if (isChecked) {
                // 체크된 경우: 마커 생성 및 표시
                const position = new kakao.maps.LatLng(lat, lng);
                const marker = new kakao.maps.Marker({ 
                    map: map, 
                    position: position, 
                    title: name 
                });
                
                // 개별 선택된 식당은 다른 스타일의 오버레이 사용
                const content = `<div style="padding:5px;background:#ff6b6b;color:white;border:1px solid #ff4757;border-radius:4px;font-size:12px;font-weight:bold;">📍 ${name}</div>`;
                const customOverlay = new kakao.maps.CustomOverlay({ 
                    position: position, 
                    content: content, 
                    yAnchor: 2.2 
                });
                
                marker.overlay = customOverlay;
                
                // 마우스 이벤트: 개별 선택된 마커는 항상 표시
                kakao.maps.event.addListener(marker, 'mouseover', () => customOverlay.setMap(map));
                kakao.maps.event.addListener(marker, 'mouseout', () => customOverlay.setMap(null));
                
                // 개별 마커 저장
                individualMarkers[restaurantId] = marker;
                
                // 오버레이를 즉시 표시 (개별 선택된 것임을 강조)
                customOverlay.setMap(map);
                
            } else {
                // 체크 해제된 경우: 마커 제거
                if (individualMarkers[restaurantId]) {
                    if (individualMarkers[restaurantId].overlay) {
                        individualMarkers[restaurantId].overlay.setMap(null);
                    }
                    individualMarkers[restaurantId].setMap(null);
                    delete individualMarkers[restaurantId];
                }
            }
        }
    </script>

</body>
</html>
